# Unix V6++ Tongji's Edition for Education

瀵IA32舵寮沐Unix V6绯荤璇ョ郴缁遍充腑甯棰澶灞绌剁㈤寮瀹锛娴澶у璁＄虹郴浣绯荤璇剧瀛瑕ㄥ17

## 绾褰锛瀛浠猗骞翠猗17 by Lao Chen

[https://web.archive.org/web/20190721215505/http://chenhz.tongji.asia/archives/1231](https://web.archive.org/web/20190721215505/http://chenhz.tongji.asia/archives/1231)

### 

32骞村璇荤澹讹猗浣绯荤猗瀛寰沌绯涓ㄨ俱瀛瀹锛姣涓璇界ラ锛浣瀵规浣绯荤ㄥ浣杩杞锛瀹ㄦ涓澶撮炬按恽界跺浠璁＄哄凡澶уぇ锛浣镐俊澶у板ㄥ瀹璇ヨ惧锛浠朵娓妤浣绯荤蜂濡浣杩杞17

20骞村宸卞濮璁叉浣绯荤璇撅棰ㄧ灏ゆ缂恽UNIX浣绯荤绋恽瓒ㄨ瑙寰杩涓沔濂芥锛瀹涓娉娉璁插锛娣卞ヨВ浜涓涓浣绯荤恽界舵UNIX V6濡涓沐灏楹婚锛翠釜稿178澶琛浠ｇ锛windows173涓澶琛锛Linux涔涓涓琛浠ｇ锛锛浣瀹浜淇卞ㄣ瀵硅灏楹婚沌浜锛缈绁缁恽娣宸撮藉交搴瑙ｅ娓妤锛荤瑙ｅ跺楦灏卞规澶浜恽稿锛濡浠瀛浠缁涓涓绉烽绫荤缈沣灏剧考ㄥ锛ｄ锛瀛寰瀹规韫浠瑕杈锛ラ绉ㄥㄩ绫讳腑澶灏绉绫诲锛浣灏辨涓ラ涓㈢缁绯荤蹇琛沌＄郴缁恽娉绯荤涓缈沣灏剧考涔存濡浣ㄣ濡浣璋17

璇达浜杩蜂璁叉蜂浣绯荤锛瀛瀛璧锋ュ璇ュ规浜锛浣瀹靛苟濡姝ゃ变UNIX V6借琛ㄦ╁氨宸叉澶辩よ哄ㄤ瀛娉ㄨユ哄ㄤUNIX V6哥瀹楠锛存娉棰杩淇UNIX V6告ュ娣辩瑙ｃｄ锛藉圭ㄥ跺浣绯荤浣涓哄渚ユ繁ヨ茶В锛Windows寰锛浣跺剧搴涓澶锛Linux瀹ㄥ饥沔剧锛浣瑙妯′澶澶э涓浣涓烘绉舵垫瀛瀵硅薄恽17

澶х害9骞村锛浜灏UNIX V6绉绘PC轰虫恽浜寮濮浠＄ㄥ涓虹、沔瀹瀵规浣绯荤瑙ｈ濂姐骞跺逛娴磋叮瀛ュ杩涓宸ヤ浜灞锛6锛甯镐绉瀛涓拌椤瑰伐浣涓ャ澶х害变浜骞村堕达瀹浜绉绘宸ヤ涓轰借╁村规瑙ｄ唬锛ㄩ㈠瀵硅薄抽拌琛浜璁捐★骞剁C++浠ュ般涓哄敖藉伴靛惊UNIX V6姊冲绠娉锛姝わ浠灏扮郴缁藉涓UNIX V6++涓烘逛究瀛琛淇UNIX V6++锛涓ㄤ负瀹寮沐浜涓沅釜澧锛瀛浠ョㄥヤ慨广缂璇恽璋璇V6++搞濡浠锛缁澶чㄥ宸ヤ藉凡瀹锛骞跺凡ㄨ剧涓榧卞昏锛浠ュ淇规瑙17

涓杩椤瑰伐绋朵绉纭澹锛浠浠板ㄥㄥ井杞婚ㄣ璋锋恽╂规┿缇藉藉朵华ㄣ娉界稿伐浣ㄤ负杩浜浼绉瀛璞讹涔浠浠琛ㄧず娣辨繁版璋锛璋浠浠浠ヨ哄宸ㄥぇ浠哄府浜杩涓姊锛朵负浣绯荤瀛浣轰鸿茬璐＄恽17

### 绮鹃璇璁17

> Wu Yuqi: 琚甯锛浠澶╁瀹ㄧ涓璇撅村瀹宠讳璁插版涓轰涪沐甯虫ㄦㄧ璇惧涓锛ㄤ瀛绉ヨ锛灏宸辩涓板浜虹缁涓浜轰氦娴锛浜х姊崇憋骞朵辩涓沐崇沔浜虹浼缁瀛锛濂借╁浜虹涔璺村瀹介骞冲蹇匡杩涓芥ㄨㄨ剧浜棰恽涓沌磋寰句娇浜烘匡版ㄧ缁锛瑙寰界惰惧匡浣ㄤ寸ㄦㄧ蹇绘汨涓绾锋涓锛骞朵ㄥ版╃锛辩姐甯浠ュ杩界版ㄧ瀹锛璋㈣阿甯17
>
> chenhz: 灏达浣濂斤涓村哄绘ф床涔锛颁瀵规澶稿澶楂淬灏ゅ跺版瀛杩杩ㄨ炬村瀹浜甯冲锛瀵逛涓琚甯ヨ达杩浠涔姣杩ユ翠护浜哄揩涔锛瑕浣蹇涓辨甯杩涓涓锛涓瀹冲锛涓瀹芥涓轰涪沐濂借甯17

> Yuanji Wang: ヨ缁琚甯骞翠猗蹇琛姘锛Unix v6++甯涓浠浠瀹浜甯姊筹朵翠釜绉浠ュ绌剁娑娆＄荤寰搴骞稿藉淇伴甯浣绯荤璇剧恽ㄧ绌剁舵靛浠甯锛骞舵姘浠ユら」浣涓烘涓璁烘恽17
> 浣绯荤纭瀹涓寰绁濂涓瑗匡瀹寰澧慵寰浣诲涓澶ㄦ蹭琚锛姣娆″ㄧ杩涓娈垫堕寸娌娣娆￠板¤杩荤瑙ｏ浣昏戒涓惧颁涪沅扮涓瑗匡绐跺拌荤瑙ｅ芥宸17
> 瀵逛浣绯荤瑙ｏ涓搴浠浠绯荤韬锛浠娑电浜瀵规翠釜璁＄虹郴缁杩浣瑙ｄ璁よ恽浠ユ浣绯荤浣涓哄ョ癸浠ョㄤ涓绯荤ㄧ瑙搴浠涓充锛辩‖浠跺拌蒋浠跺荤瑙ｆ翠釜璁＄哄绉锛灏卞ソ璞′绔ㄤ琛ㄥ锛芥涓轰榻胯疆浣锛ラ浠浠濡浣宸ヤ锛濡浣杈惧拌℃跺归界锛涓沐戒涪沌浜躲17
> 娈垫堕磋浜璧峰充浣绯荤璇棰锛版轰捐捣褰规淮锛瑙棰澶甯灏卞棰垛甯浜UnixV6++锛杩澶ф绠涓沌涓澶т灏宸у涓虹с17
>
> chenhz: 浣讹璋㈣阿浣瑷浜鸿达藉瑰诲鸿瓒宸辩瀛楂¤甯涓沐濂借甯界朵韬浼绉汨瑰伙浣浠ラ茬璇磋宸辨濂借甯浜锛靛点17
> 娆℃璋浣浠ヨ宸辩烘у涓V6++虹鸿茶础锛
> 椤轰究浣辨悒涓涓锛变浣ㄦｇ猗澹瑷沅腑蹇芥锛充杩浜洪锛杩浼涓惧猗璁＄鸿甯璁插测璁插骇17

### 朵璁板

> 浣ラ甯浠ュㄥ娴澶涓沐恽杩瀹ゅ㈤芥绔涓璇剧瀛恽ｆ跺娌℃PPT锛琚澶撮芥绮绗绘绋撅ㄥぇ剧焊缁娴绋炬沣ヤ瀛锛跺浜涓沔¤璇撅逛负瑙姝锛瑙寰宸卞ぇ瀛绉浣绯荤藉浜ｆ跺浠姝ｅ甫沅涪沌兢纭澹v6++......锛fy蹇锛缁杩gty癸17

## 琚杩琛澧17

褰浠ｇ宸插ㄤ互涓杞浠剁澧杩琛锛17

 **`Arch Linux`**

* `GNU/Linux 6.8.7-arch1-Adashima-T2 PREEMPT_DYNAMIC`
* `gcc version 13.2.1 20240417`
* `GNU gdb 14.2`
* `cmake version 3.29.2`
* `GNU Make 4.4.1`
* `QEMU version 9.0.0 (qemu-system-i386)`
* `KDE Plasma 6.0.4 (Wayland)`

**`Debian 12`**

* `GNU/Linux 6.1.0-21-amd64`
* `gcc (Debian 12.2.0-14) 12.2.0`
* `GNU gdb (Debian 13.1-3) 13.1`
* `cmake version 3.25.1`
* `GNU Make 4.3`
* `QEMU version 7.2.9 (qemu-system-i386)`
* `KDE Plasma 5.27.5 (X11)`

## 存拌板

### 2024存

Unix V6++涓绘2008骞村瀹锛充锛2024骞1741730ワ宸叉宸涓澶1715骞村层堕ㄥ璁捐″琚э句互ㄧ颁唬璁＄轰杩琛讹璇ョ郴缁瀛ㄨ稿浼版广17

ㄥ绉姣涓璁捐￠」讹GTY 瀵17 Unix V6++ 杩琛浜涓浜瑰锛璁╁跺浠ュㄦ寸颁唬澧涓杩琛锛骞舵瑰浜绯荤ㄥ璁捐°17

涓㈠瀵硅存圭ㄥ璇缁璇存恽17

#### 缂璇绯荤

ョ缂璇绯荤瀹ㄥ轰17 Makefile板缂璇绯荤逛17 CMake 17 Makefile 娣峰浣跨ㄣ朵腑锛Makefile ㄤ澶浜や浠わ舵у CMake 瀹缂璇寤虹宸ヤ恽17

浼锛缂璇杩琛涓汨浠ュｆ烽缃澧锛骞跺ㄥ涓蹇锋瑰涓璺虫ヨ烦汇17

姝ゅ锛缂璇绯荤浼涓烘涓瀛绋搴剁 ELF 17 PE 朵腑锛ELF 渚17 GDB 杞戒娇锛PE 渚17 v6++ 镐娇ㄣ17

#### VSCode 缃浠

版村浜哄娆㈢17 VSCode 寮锛板椤圭涓17 VSCode 缃浠讹17 C++ 澶存浠舵绱㈣矾寰浠ュ璋璇ㄥㄥ般17

瑙浠跺す锛`.vscode`

#### 哄17

轰 Bochs ㈡ QEMU

鸿琛瀛浠 32M 17 64M锛瀛杩涓瑰ㄥソ娌′虎沅涔锛

#### 浠剁郴缁妯″甯

ョ跺告浠朵借杩17 99K浜瀹涓锛琚绯荤澶у宸茬濂藉′杩涓间涓娣诲板斤稿ぇ灏寰瀹规绐磋涓涓锛瀵艰村告娉琚瀹村杞姐17

杩灏浠剁郴缁17 INode 浠ュ哄翠绉伙浠灏稿ぇ灏涓╁ぇ颁 398 涓锛17 199K锛剁瓒冲浣跨ㄣ17

| 瀛惧瀹             | 村瀛剧17 | 村瀛剧17 |
| -------------------- | -------------- | -------------- |
| ㄥ瀵硷boot.bin锛17 | [0, 0]         | [0, 0]         |
| 革kernel.bin锛17   | [1, 199]       | [1, 399]       |
| SuperBlock           | [200, 201]     | [400, 401]     |
| INode                | [202, 1023]    | [402, 1223]    |
| Data                 | [1024, 17999]  | [1224, 18199]  |
| Swap                 | [18000, 20159] | [18200, 20359] |

**瑰娉ㄦ锛浠剁郴缁甯村锛寰灞瀛ㄣ浣绯荤璇剧璁捐°浣涓涓朵浠剁郴缁缂杈ㄥ娉存ヤ娇ㄣ瑕灏朵腑涓浣缃宠剧疆存板琚恽17**

浠ｇ达17

```cpp

// git diff ./src/include/FileSystem.h
-       static const int SUPER_BLOCK_SECTOR_NUMBER = 200; 
+       static const int SUPER_BLOCK_SECTOR_NUMBER = 400;   

-       static const int INODE_ZONE_START_SECTOR = 202; 
-       static const int INODE_ZONE_SIZE = 1024 - 202;  
+       static const int INODE_ZONE_START_SECTOR = 402; 
+       static const int INODE_ZONE_SIZE = 1224 - 402;  
 
-       static const int DATA_ZONE_START_SECTOR = 1024;   
-       static const int DATA_ZONE_END_SECTOR = 18000 - 1;  
-       static const int DATA_ZONE_SIZE = 18000 - DATA_ZONE_START_SECTOR; 
+       static const int DATA_ZONE_START_SECTOR = 1224;   
+       static const int DATA_ZONE_END_SECTOR = 18200 - 1; 
+       static const int DATA_ZONE_SIZE = 18200 - DATA_ZONE_START_SECTOR; 

// git diff ./src/mm/SwapperManager.cpp
-unsigned int SwapperManager::SWAPPER_ZONE_START_BLOCK = 18000;
+unsigned int SwapperManager::SWAPPER_ZONE_START_BLOCK = 18200;
```

#### PE Parser

PE Parser瀹浜姣涓娈电瀛浣娆★浣扮缂璇ㄤ涓沐靛惊璇ヨ锛瀵艰村ц绋搴芥娉姝ｇ‘杞姐PE Parser圭ㄥ绗涓插归瑰瀵绘鹃汨绋搴娈碉浠ヨВ宠ラ棰17

姝ゅ锛 PE Parser ㄥ浠ｇ瀛ㄩ璇锛宸插归ㄥ棰杩琛淇澶恽17

瑙锛[git commit](https://github.com/FlowerBlackG/unix-v6pp-tongji/commit/9601efc2a8a99b7587aadade963fc64ae06b1d8e#diff-6fe8cd06b96adeca203104e06aaedc863e105a96bbb2dc2707b5f6777f9498b1)

#### 板锛ELF

17 ELF 17 Unix 瀹舵姝ｇц浠舵煎锛涓 GNU/Linux 涓 GDB 杞 PE 煎浠朵洪棰锛瑰 ELF 煎杞藉ㄣ17

**娉锛bug璇ュ芥涓ㄣ17**

#### Splash

寮沔烘堕寮沐剧恽17

![img](tools/unixv6pp_splash/v6pp_splash.bmp)

浠ュ17 `src/CMakeLists.txt` 绂ㄣ17

#### PSE

ㄥㄥ瀵艰绋涓锛17 CPU PSE 斤浠ユ 4MB 澶ч〉灏17

琚锛[https://wiki.osdev.org/Paging](https://wiki.osdev.org/Paging)

#### VESA

浣跨 VESA у舵剧ず灞锛骞跺ㄥ朵瀹颁涪沅釜剧ず绌洪存村ぇ锛插僵磋充附恽灞骞婊ㄧу跺般17

杩17 VESA 椹卞ㄤ QEMU 骞冲版璇锛涓淇璇ㄥ朵澧涓纭姊悃恽17

锛VESA 惧灏绌洪磋剧疆ㄥ稿虹 128MB 浣缃锛 3GB + 128 MB 澶锛锛惧姊慊澶у绾涓17 2MB17

VESA 浠ュ17 src/CMakeLists.txt ㄥ炽17

| 锛CRT锛17                            | 扮锛VESA锛17                           |
| -------------------------------------- | -------------------------------------- |
| ![img](./img/qemu-v6pp-without-vesa.jpg) | ![img](./img/qemu-v6pp-vesa-enabled.jpg) |

#### DMA

ョ浠ｇ骞舵病ㄥ饥沐17 DMA 姐芥涓 Bochs 榛璁ゅㄤ锛浜涔浠ｇ涓存病洪17

QEMU 妯℃缁榛璁ゅ抽 DMA 斤瑕ㄥ恽17

#### libyrosstd

寮ユヨ [https://github.com/FlowerBlackG/YurongOS/blob/master/src/lib](https://github.com/FlowerBlackG/YurongOS/blob/master/src/lib) 虹、沐浠ｇ恽璇ュユ村己戒村ソц姐17

渚锛

1. 浣跨ㄥ琚锛锛 `glibc` 17 `strlen` 芥帮涓娆℃悃浠ュゆ17 4 涓瀛恽17
2. 蹇棰瀛疯 `memcpy`锛ㄥュ撮朵娆℃悃疯17 4 瀛杩涓硅浠ュ澶х搴17 VESA Console 婊灞浣楠锛跺浠ヨ浣跨AVXSSE浠よ涓姝ュ锛17
